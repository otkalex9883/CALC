import streamlit as st
import datetime
import io
import os
import re
import sys
import locale

# --- 한글 달력 및 요일을 위한 locale 설정(서버 측) ---
try:
    locale.setlocale(locale.LC_TIME, 'ko_KR.UTF-8')
except locale.Error:
    pass  # 환경에 한글 Locale이 없을 때는 무시

# ✅ 중요:
# 'd120' 같은 일 단위는 반드시 문자열로 넣어야 합니다. (따옴표 필수)
product_db = {
    "LIGHT&JOY_당을줄인 김천자두쨈 290G": 12,
    "LIGHT&JOY_당을줄인 논산딸기쨈 290G": 12,
    "LIGHT&JOY_당을줄인 논산딸기쨈 480G": 12,
    "LIGHT&JOY_당을줄인 청송사과쨈 290G": 12,
    "간장찜닭양념 240G": 18,
    "간장찜닭양념 480G": 18,
    "갈비양념(호주) 240G": 18,
    "검시럽(롯데리아) 11G": 9,
    "닭볶음탕양념 235G": 18,
    "닭볶음탕양념 470G": 18,
    "돼지갈비양념 240G": 18,
    "돼지갈비양념 480G": 18,
    "돼지갈비양념(미국) 480G": 18,
    "돼지불고기양념 245G": 18,
    "돼지불고기양념 500G": 18,
    "돼지불고기양념(미국) 500G": 18,
    "딸기버터쨈 280G": 10,
    "딸기잼(스타벅스) 12G": 6,
    "딸기잼(에그드랍) 12G": 6,
    "딸기쨈 10KG": 4,
    "딸기쨈 300G": 24,
    "딸기쨈 500G": 24,
    "딸기쨈 850G": 24,
    "딸기쨈(엔제리너스커피) 12G": 6,
    "딸기쨈디스펜팩(KFC) 12G": 6,
    "딸기토핑(맥도날드) 1KG": 6,
    "맛있는딸기쨈830g": 24,
    "맥도날드_스위트앤사워소스(대만R) 28G": "d120",
    "메이플시럽(제이앤이) 1KG": 12,
    "믹스피클(제너시스) 3KG": 3,
    "믹스피클(프레시지) 3KG": 4,
    "불고기양념(호주) 240G": 18,
    "블루베리쨈 300G": 24,
    "블루베리쨈 500G": 24,
    "사과쨈 300G": 24,
    "사과쨈 500G": 24,
    "소갈비양념 240G": 18,
    "소갈비양념 480G": 18,
    "소불고기양념 240G": 18,
    "소불고기양념 480G": 18,
    "스위트앤젤_밀감(18입) 90G": 6,
    "스위트앤젤_복숭아(18입) 90G": 6,
    "스위트앤젤_파인(18입) 90G": 6,
    "스위트오이피클 3KG": 12,
    "아삭 오이 피클 240G": 6,
    "아삭 오이 피클 420G": 6,
    "아삭 오이&무 피클 240G": 6,
    "아삭 오이&무 피클 420G": 6,
    "앙버터쨈 280G": 10,
    "오늘의샐러드_코울슬로 100G": 1,
    "오늘의샐러드_콘샐러드 100G": 1,
    "오뚜기딸기쨈(디스펜팩)(240개입) 12G": 6,
    "오뚜기딸기쨈(디스펜팩)(480개입) 12G": 6,
    "오뚜기일회용딸기쨈 12G": 6,
    "오쉐프_떠먹는샤인머스캣(18입) 90G": 6,
    "오쉐프_떠먹는애플망고 90G": 6,
    "오쉐프_메이플시럽(디스펜팩) 11G": 6,
    "오쉐프_슬라이스오이피클 3KG": 6,
    "오쉐프_오미자믹스피클 3KG": 6,
    "오쉐프_초코소스(디스펜팩) 12G": 6,
    "제주담음_제주청귤마말레이드_280G": 12,
    "제주담음_제주한라봉마말레이드_300G_S": 24,
    "코울슬로(맥도날드) 100G": 1,
    "코울슬로(파파존스) 100G": 1,
    "코울슬로(프랭크버거) 100G": 1,
    "코울슬로(피자헛) 100G": 1,
    "콘샐러드(맘스터치) 100G": 1,
    "콘샐러드(파파존스) 100G": 1,
    "콘샐러드(프랭크버거) 100G": 1,
    "콘샐러드(피자헛) 100G": 1,
    "포도쨈 300G": 24,
    "포도쨈 500G": 24,
    "프레스코_파스타소스 토마토 600G": 12,
    "한컵코울슬로 100G": 1,
    "한컵콘샐러드 100G": 1,
    "후레쉬오이피클(쏘렌토) 3KG": 3,
    "후루츠쨈 300G": 24,
    "후루츠쨈 500G": 24,
    "후루츠쨈 850G": 24,
    ####여기까지 2팀##########
    "오뚜기 골드마요네스": 10,
    "60계 마요네스": 8,
    "핫케익시럽(수출용)": 6,
    "핫케익시럽": 6,
    "카페시럽(버거킹)": 12,
    "슈가시럽(M)": 9,
    "오뚜기 떡볶이소스(세준)": 12,
    "오뚜기 국물 떡볶이 소스(세준)": 12,
    "오뚜기 라볶이소스(세준)": 12,
    "돈까스소스(소포장)": 12,
    "양파절임소스": 12,
    "제주식 멜젓소스": 12,
    "소떡소스(태성)": 12,
    "비빔장(SF)": 12,
    "김치말이육수(오뚜기라면)": 12,
    "가쓰오우동장국(오뚜기라면)": 12,
    "황태콩나물해장국밥 액상스프": 12,
    "잡채소스(SF)": 12,
    "중화 XO 양념소스": 12,
    "진한사골육수(세준)": 8,
    "발사믹드레싱(잇츠온)": 6,
    "장어구이양념(장어장) 순한맛": 6,
    "장어구이양념(장어장) 매운맛": 6,
    "돈까스소스(유일푸드)": 6,
    "오리엔탈소스(샐러드보울)": 6,
    "11겹 등심돈까스소스": 6,
    "오즈키친 양념치킨소스 90G": 18,
    "오즈키친 마늘간장치킨소스 90G": 18,
    "이탈리안바질드레싱(만나씨이에이)": 6,
    "칠리드레싱(만나씨이에이)": 6,
    "유자프렌치드레싱(만나씨이에이)": 6,
    "데리야끼소스 30g": 6,
    "버터갈릭소스(더파이러츠)": 6,
    "레몬파인드레싱(잇츠온)": 6,
    "오리엔탈드레싱(잇츠온)": 6,
    "유자소이소스(잇츠온)": 6,
    "메이플트러플드레싱(만나씨이에이)": 6,
    "컵 떡볶이소스(세준)": 14,
    "컵 떡볶이소스 매운맛(세준)": 14,
    "두수고방 된장양념": 12,
    "홀그레인발사믹드레싱(프레시지)": 6,
    "청양피쉬소스(잇츠온)": 6,
    "오므라이스 소스": 12,
    "후추떡볶이소스(세준)": 12,
    "올리브유발사믹드레싱(만나씨이에이)": 6,
    "진한황태육수(세준)": 8,
    "제로슈가허브프렌치드레싱(팜에이트)": 6,
    "오즈키친 스윗허니치킨소스": 18,
    "오즈키친 레드칠리치킨소스": 18,
    "태양초 비빔국수소스": 6,
    "스위트칠리소스(버거킹)": 5,
    "샐러디 발사믹드레싱": 4,
    "샐러디 타바스코오리엔탈드레싱": 4,
    "옛날 잡채덮밥 소스": 12,
    "왕갈비통닭소스": 18,
    "스위트칠리소스(NBB)": 6,
    "이탈리안드레싱(NBB)": 6,
    "국밥양념장(79네수육국밥)": 4,
    "고추장비빔드레싱(샐러디)": 6,
    "돈카츠소스(정돈)": 12,
    "튀만전 찍먹소스": 12,
    "오리엔탈드레싱(읍천리382)": 6,
    "진짬뽕별첨소스": 6,
    "볶음고추장": 12,
    "저당 발사믹드레싱(잇츠온)": 6,
    "타바스코 고추장 핫소스(증정용)": 15,
    "사골곰탕밥 액상소스": 12,
    "미역국밥 액상소스": 12,
    "저당스파이시오리엔탈소스(포케올데이)": 6,
    "핫소스": 12,
    "오'쉐프 핫소스": 12,
    "타바스코소스": 12,
    "스파이시마요드레싱(프레시지)": 6,
    "스파이시랜치드레싱(프레시지)": 6,
    "치폴레마요(키친서울)": 4,
    "메이플드레싱(프레시코드)": 6,
    "흑임자드레싱(유일푸드)": 4,
    "시저드레싱(샐러드판다)": 4,
    "스리라차마요드레싱(샐러드판다)": 6,
    "흑임자어니언드레싱(잇츠온)": 6,
    "랜치시저드레싱(잇츠온)": 6,
    "오리엔탈샐러드소스(SW) 30G": 6,
    "오리엔탈샐러드소스(SW) 50G": 6,
    "키위샐러드소스(SW) 30G": 6,
    "키위샐러드소스(SW) 50G": 6,
    "1000아일랜드샐러드소스(SW) 30G": 6,
    "1000아일랜드샐러드소스(SW) 50G": 6,
    "칠리마요드레싱(잇츠온)": 6,
    "오즈키친 스파이시마요소스": 12,
    "마요네스소스": 4,
    "타르타르소스": 4,
    "트리플치즈칠리드레싱(잇츠온)": 6,
    "샐러디 오리엔탈드레싱": 4,
    "샐러디 레몬드레싱": 4,
    "샐러디 크리미칠리드레싱": 4,
    "샐러디 시저드레싱": 4,
    "샐러디 크리미할라피뇨드레싱": 4,
    "시저드레싱(NBB)": 6,
    "허니머스타드소스(잇츠온)": 6,
    "와사비마요(정돈)": 4,
    "참깨드레싱(정돈)": 4,
    "오즈키친 갈릭마요소스": 12,
    "바질랜치드레싱(잇츠온)": 6,
    "갈릭칠리드레싱(읍천리)": 6,
    "랜치드레싱(읍천리382)": 6,
    "케이준칠리드레싱(읍천리)": 6,
    "스리라차마요드레싱(읍천리)": 6,
    "오'쉐프 크림어니언드레싱": 6,
    "허니머스타드드레싱(범용)": 6,
    "허니머스타드드레싱(치킨플러스) 12G": 4,
    "허니머스타드드레싱(롯데푸드) 12G": 4,
    "허니머스타드드레싱(마트킹) (12GX100)": 4,
    "허니머스타드드레싱(KFC)": 5,
    "허니머스타드(BK)": 4,
    "허니 머스타드 드레싱-L": 6,
    "맘스터치 허니머스타드": 4,
    "신스위트앤사워(롯데리아)": 6,
    "허니머스타드(명랑)": 6,
    "허니머스타드드레싱(호식이두마리치킨)": 6,
    "허니머스타드드레싱 (또래오래)": 6,
    "마리드레싱(스쿨푸드)": 3,
    "허니머스타드드레싱(프랭크버거)": 6,
    "갓튀긴후라이드 허니머스타드": 4,
    "LIGHT&JOY_1/2하프케찹(200개입)9G_증정용": 12,
    "와사비마요소스": 6,
    "오'쉐프 마요네스": 8,
    "마요네스(SHAKE SHACK)": 5,
    "핫소스(피자헛)": 12,
    "마요소스(33떡볶이)": 6,
    "와사비마요소스(33떡볶이)": 6,
    "오뚜기 마요네스": 9,
    "오뚜기 매코매요": 6,
    "백소정다시마초소스": 6,
    "오쉐프 달콤한양념치킨소스": 9,
    "1000아일랜드드레싱": 8,
    "핫칠리(명랑)": 6,
    "오뚜기 토마토케챂": 12,
    "토마토케찹(200개입) 9G": 12,
    "토마토케찹(마트킹) (9GX100)": 12,
    "신맥도날드케찹 9G": 6,
    "신맥도날드케찹(대만) 9G": 6,
    "BK토마토케찹": 12,
    "명랑시대 토마토케찹": 12,
    "맘스터치 토마토케챂": 12,
    "프랭크버거 토마토케찹": 12,
    "KFC 토마토케챂": 12,
    "롯데리아 토마토케챂": 12,
    "삼첩분식 토마토케첩": 12,
    "토마토케챂 DOWNTOWNER": 12,
    "토마토케찹(빙그레)": 12,
    "스위트칠리소스(Sweet Chili Sauce)": 4,
    "스위트칠리소스(맥도날드 수출용)-대만": 5,
    "스위트칠리소스(맥도날드 수출용)-홍콩": 5,
    "스위트앤사워소스(Sweet n' Sour)": 4,
    "맥도날드 익스트림핫페퍼소스(홍콩)": 4,
    "맥도날드_스위트칠리소스(태국)": 4,
    "스위트칠리소스(Sweet Chili Sauce)(한정판)": 4,
    "오렌지칠리소스": 4,
    "맥도날드_세이버리칠리소스": 5,
    "네더불꽃소스(M)": 4,
    "케이준소스(Cajun Sauce)(내수)": 3,
    "케이준소스(Cajun Sauce)(대만)": 3,
    "케이준소스(맥도날드 수출용)": 4,
    "레몬아이올리소스(홍콩맥도날드)": 4,
    "스위트칠리소스(KFC)": 4,
    "양념치킨소스(오부장)": 6,
    "매운양념소스(오부장)": 6,
    "매콤달콤칠리소스(동명카츠)": 6,
    "본스 핫볼케이노 소스": 4,
    "핫데리야끼소스(상상)": 6,
    "요거트소스(푸드앤터)": 4,
    "본스 허니머스타드": 4,
    "잭슨피자 케이준소스": 4,
    "KFC 스모키머스타드": 6,
    "허니머스타드드레싱(상상)": 6,
    "발사믹드레싱(팜에이트)": 6,
    "발사믹드레싱(하늘재)": 6,
    "오리엔탈드레싱(하늘재)": 6,
    "발사믹드레싱(뱃살도둑)": 6,
    "오리엔탈드레싱(뱃살도둑)": 6,
    "올리브유발사믹드레싱(샐러드박스)": 6,
    "할라피뇨발사믹드레싱(샐러드박스)": 6,
    "유자드레싱(샐러드박스)": 6,
    "오리엔탈드레싱(샐러드박스)": 6,
    "이탈리안드레싱(샐러드박스)": 6,
    "오리엔탈드레싱(팜에이트)": 6,
    "허니머스타드소스(팜에이트)": 4,
    "요거트드레싱(팜에이트)": 4,
    "렌치시저드레싱(하늘재)": 4,
    "어니언크림드레싱(뱃살도둑)": 4,
    "올리브바질드레싱(뱃살도둑)": 6,
    "참깨드레싱(팜에이트)": 4,
    "허니머스타드소스(은성)": 4,
    "랜치드레싱(샐러드박스)": 4,
    "양파드레싱(샐러드박스)": 4,
    "흑임자드레싱(샐러드박스)": 4,
    "와사비간장드레싱(샐러드박스)": 6,
    "흑깨간장드레싱(샐러드박스)": 6,
    "그린칠리드레싱(샐러드박스)": 4,
    "칠리드레싱(은성)": 4,
    "오뚜기 양념치킨소스": 9,
    "경양식돈까스소스": 12,
    "진한멸치육수로맛을낸떡볶이소스 1240 g": 6,
    "오뚜기 1000아일랜드드레싱": 10,
    "갈릭 아이올리소스": 9,
    "홀그레인머스타드": 12,
    "허니머스타드": 10,
    "오뚜기 참깨드레싱": 9,
    "삼겹살 제주식멜젓소스": 12,
    "고소한 참깨드레싱": 9,
    "과일담은 소불고기 큰양념": 18,
    "과일담은 소갈비 큰양념": 18,
    "과일담은 돼지갈비 큰양념": 18,
    "과일담은 돼지불고기 큰양념": 18,
    "소불고기양념(업소용) 20 kg": 6,
    "소불고기큰양념": 18,
    "소불고기큰양념 10 kg": 18,
    "소갈비큰양념": 18,
    "소갈비큰양념 10 kg": 18,
    "돼지갈비큰양념": 18,
    "돼지갈비큰양념 10 kg": 18,
    "돼지불고기큰양념": 12,
    "오'쉐프 스위트칠리소스": 9,
    "오뚜기 굴소스": 12,
    "오뚜기 스위트 칠리소스": 12,
    "삼겹살 양파절임소스": 12,
    "오'쉐프 닭강정소스 10 kg": 6,
    "오'쉐프 떡볶이소스 10 kg": 6,
    "오'쉐프 가쓰오우동다시": 12,
    "오'쉐프 가쓰오국수장국": 12,
    "오'쉐프 우동소스 골드": 12,
    "돈까스소스 2.1 kg": 12,
    "돈까스소스 21 kg": 12,
    "Tonkatsu Sauce(미국) 2.1 kg": 12,
    "스테이크소스 2.1 kg": 12,
    "스테이크소스 21 kg": 12,
    "우스타소스 2.1 kg": 12,
    "떡볶이 소스": 6,
    "빅마마 하와이안BBQ소스": 6,
    "불고기양념Y": 12,
    "진품오리 불고기양념": 12,
    "소불고기양념(오뚜기냉동)": 12,
    "데리야끼소스(싸다김밥)": 6,
    "농축사골액U": 12,
    "쇠고기농축액": 6,
    "간편 장아찌소스": 12,
    "닭불고기양념(웰스토리)": 6,
    "기묘한 양념치킨(알통)": 6,
    "기묘한 데리야끼(알통)": 6,
    "기묘한 숯불바베큐(알통)": 6,
    "멸치엑기스 (말통)": 6,
    "멸치추출액 1호기": 1,
    "멸치 육수": 12,
    "데리야끼소스": 12,
    "바베큐소스": 12,
    "바베큐소스 매운맛": 12,
    "삼겹살 제주식 멜젓소스": 12,
    "삼겹살 파채무침소스": 12,
    "양념치킨소스_오리지널(미국)": 12,
    "양념치킨소스_매운맛(미국)": 12,
    "간편장아찌소스": 12,
    "삼겹살 와사비 고추장소스": 12,
    "키위 저칼로리 드레싱": 6,
    "그린애플발사믹 저칼로리 드레싱": 6,
    "오리엔탈 저칼로리 드레싱": 6,
    "튀만전찍먹소스": 12,
    "창녕갈릭 소이소스": 10,
    "Seoul Dippin g Sauce(미국)": 12,
    "옛날잡채소스": 12,
    "저당 삼겹살 양파절임소스": 12,
    "저당 스위트 칠리소스": 12,
    "스쿨푸드 마요소스": 6,
    "와사비소스": 8,
    "칼로리를 줄인 시저드레싱": 6,
    "칼로리를 줄인 참깨드레싱": 6,
    "칼로리를 줄인 아몬드캐슈넛드레싱": 6,
    "핫퍼지토핑(M)": 6,
    "겨자냉채소스": 6,
    "맥도날드 토마토케챂": 6,
    "오'쉐프 1000아일랜드드레싱": 4,
    "콩샌 샌드위치소스": 4,
    "사우전아일랜드드레싱(바이올푸드)": 4,
    "파인애플키위드레싱(골든카우보이)": 4,
    "키위드레싱(바이올푸드글로벌)": 4,
    "마리드레싱(BGF)": 3,
    "머스터드마요소스(뉴욕버거)": 4,
    "화이트소스(바핫)": 4,
    "양마소스(백소정)": 4,
    "참깨드레싱(백소정)": 4,
    "겨자마요소스(북문당)": 5,
    "오'쉐프 갈릭치즈드레싱": 4,
    "오'쉐프 딸기요거트드레싱": 4,
    "오'쉐프 파인애플드레싱": 4,
    "오'쉐프 흑임자&갈릭드레싱": 4,
    "오'쉐프 양파드레싱": 4,
    "오'쉐프 와사비마요드레싱": 4,
    "오'쉐프 아삭한 타타르드레싱": 4,
    "오'쉐프 화이트스위트소스": 4,
    "마코참깨드레싱(미스터빠삭)": 4,
    "머스타드소스(장푸드)": 4,
    "키위샐러드소스(SW)": 6,
    "타르타르소스(미소야)": 4,
    "T.I소스(맘스터치)": 4,
    "피자알볼로 랜치드레싱소스": 4,
    "MOS 타르타르소스": 4,
    "마요드레싱(KFC)": 4,
    "사우전아일랜드소스(KFC)": 4,
    "허니머스타드드레싱(샐러디)": 4,
    "오리엔탈드레싱(샐러디)": 4,
    "크리미칠리드레싱(샐러디)": 4,
    "크리미드레싱(BMC)": 4,
    "크리미칠리드레싱(서일)": 4,
    "갈릭디핑소스(스타푸드)": 4,
    "오'쉐프 오늘은 우리 토마토케챂": 12,
    "사우전드레싱(슬로우보울)": 6,
    "시저드레싱(칙바이칙)": 4,
    "준시저드레싱(칙바이칙)": 4,
    "스모키베이컨소스(M)": 4,
    "타르타르소스(SW)": 6,
    "1000아일랜드샐러드소스(SW)": 6,
    "크리미할라피뇨드레싱(샐러디)": 4,
    "갈릭아이올리소스(남향푸드또띠아)": 4,
    "쓰리라차소스(에그드랍)": 4,
    "매콤마요드레싱": 4,
    "오리엔탈참깨드레싱": 4,
    "버거소스(버거스올마이티)": 4,
    "화이트 스위트 칠리소스(파파이스)": 4,
    "타타르소스(파파이스)": 4,
    "마요소스(이나타코전용)": 4,
    "스리라차마요소스(맘스터치)": 4,
    "참깨드레싱(샤브 20)": 4,
    "당근라페용소스(샐러디)": 4,
    "케요네스(남문통닭)": 4,
    "갈릭요거트드레싱(바음)": 4,
    "DRP마요소스": 6,
    "사우전드레싱(카츠젠)": 4,
    "마늘소스(뽁식당)": 4,
    "트러플마요소스(홍콩)": 4,
    "켄터키소스(KFC)": 4,
    "아이올리소스(스타벅스)": 4,
    "핫베이컨소스(스타벅스)": 4,
    "버거운버거소스(버거운버거)": 4,
    "사우전드레싱(카츠몽)": 4,
    "크리미칠리소스(버거킹)": 4,
    "매코매요(CVS)": 5,
    "참깨흑임자드레싱(민족)": 6,
    "마요소스(BHC)": 6,
    "스모키케요네스(BGF)": 4,
    "사우전아일랜드소스(금화)": 4,
    "케이준소스(S)": 4,
    "검은깨마요(깐깐한족발)": 4,
    "버거소스(BGF)": 4,
    "케요네스(7분통닭)": 4,
    "참깨드레싱(이랜드)": 4,
    "타타르소스(금화)": 4,
    "리치브라운(버거킹)": 4,
    "트러플마요(벤티버거)": 4,
    "기묘한청양드레싱(알통)": 4,
    "화이트버거소스(벤티버거)": 4,
    "참깨드레싱(샤브르정원)": 4,
    "키위드레싱(DH)": 4,
    "케요네스(천년닭강정)": 6,
    "갈릭소스(참토스트)": 4,
    "크림스프어니언소스(브뤼셀프라이)": 6,
    "오'쉐프 샤인머스캣드레싱": 6,
    "핫트러플마요(버거킹)": 4,
    "허니머스타드드레싱(푸디스트)": 6,
    "키위드레싱(푸디스트)": 6,
    "오'쉐프 고추마요소스": 4,
    "비스트로머스타드(이케아)": 6,
    "오'쉐프 크리미시저드레싱": 4,
    "트러플레드소스(M)": 3,
    "그릭랜치소스(롯데리아)": 6,
    "브라운페퍼콘소스(버거킹)": 4,
    "블랙페퍼치즈소스(버거킹)": 4,
    "허니레몬마요소스(브런치빈)": 6,
    "NY시그니처소스(뉴욕버거)": 4,
    "크리스퍼마요소스(버거킹)": 6,
    "랜치소스(참토스트)": 4,
    "겨자마요소스(참토스트)": 4,
    "O'늘케어 저당참깨드레싱": 6,
    "스리라차소스(참토스트)": 4,
    "참깨드레싱(롯데리아)": 4,
    "샐러드드레싱 1호": 4,
    "마요-감마 2": 5,
    "마요베이스(풍림푸드)": 4,
    "마요소스(풍림푸드)": 4,
    "오'쉐프 타타르소스": 4,
    "오'쉐프 야채샐러드용드레싱": 4,
    "오'쉐프 코울슬로드레싱": 4,
    "치폴레마요(남향)": 4,
    "허니머스타드드레싱(포르미)": 4,
    "마요드레싱-GS": 3,
    "마일드 버거소스(GS)": 4,
    "체다치즈드레싱(GS)": 4,
    "시저드레싱(샐러디)": 4,
    "참깨소스(모던샤브하우스)": 4,
    "마요소스(강다짐)": 4,
    "갈릭마요소스(워크위드FnC)": 4,
    "오꼬노미마요소스(백소정)": 4,
    "랜치소스(워크위드FnC)": 4,
    "홀그레인마요소스(워크위드FnC)": 4,
    "샐러드드레싱(한국농수산)": 4,
    "오'쉐프 칠리소스": 6,
    "오'쉐프 깐풍기소스": 6,
    "오'쉐프 데리야끼소스": 6,
    "오'쉐프 불고기버거소스 2KG": 6,
    "오'쉐프 바베큐소스": 12,
    "간장마늘소스(맘스터치)": 6,
    "간장소스(투가이즈)": 6,
    "갈릭스위트소스(알통)": 6,
    "그린카레육수베이스(모던샤브하우스)": 4,
    "블랙바베큐소스(버거킹)": 6,
    "닐리골드소스": 12,
    "데리야끼소스(얼라이브러쉬)": 6,
    "돈까스소스(장푸드)": 6,
    "돈까스소스(카츠모리)": 6,
    "떡갈비김밥용소스": 6,
    "레몬시럽(이삭)": 6,
    "마늘소스(낭만치맥)": 9,
    "마늘탕수육소스(리얼안심탕수육)": 6,
    "마제소바소스(백소정)": 6,
    "맛난 어묵육수": 6,
    "망고버터용믹스": 3,
    "매운돈까스소스(미스터빠삭)": 6,
    "매운된장육수(모던샤브하우스)": 4,
    "매운양념소스(낭만치맥)": 6,
    "맥도날드 행운버거소스": 3,
    "스위트칠리소스(M)": 6,
    "메이플향시럽": 6,
    "바베큐소스(에버랜드)": 6,
    "버무리 멸치육수베이스": 6,
    "버섯육수(모던샤브하우스)": 6,
    "본스갈릭&캐럿소스": 6,
    "본스핫볼케이노소스": 6,
    "부리또소스(밀플랜비)": 6,
    "부리또소스(밀플랜비) 매운맛": 6,
    "부리또소스(밀플랜비)약간매운맛": 6,
    "돈까스소스(SW)": 6,
    "불고기버거소스(얼라이브러쉬)": 6,
    "불고기소스(M)": 3,
    "불고기소스(버거킹)": 6,
    "사천소스(바음푸드)": 6,
    "새콤비빔소스(웰스토리)": 6,
    "스모크바비큐소스(써브웨이)": 6,
    "스위트칠리소스(명랑)": 6,
    "스키야키간장육수(모던샤브하우스)": 6,
    "스파게티소스(파스타집이야)": 6,
    "아라비아따소스(M)": 3,
    "알싸한마늘소스(79대포)": 6,
    "알통떡강정소스(매운맛)": 6,
    "알통떡강정소스(순한맛)": 6,
    "알통떡강정소스(중간맛)": 6,
    "양념치킨소스_매운맛(대만)": 9,
    "양념치킨소스_오리지널(대만)": 9,
    "양송이소이소스(남향)": 6,
    "양식소스(미스터빠삭)": 6,
    "영구스 피자소스": 6,
    "오'쉐프 깐풍칠리소스": 6,
    "오'쉐프 나트륨을 줄인 후루츠케챂": 12,
    "오'쉐프 닭강정소스": 6,
    "오'쉐프 떡볶이소스": 6,
    "오'쉐프 만능볶음양념": 12,
    "오'쉐프 만능불매콤양념": 12,
    "오'쉐프 만능비빔장": 12,
    "오'쉐프 매운데리야끼소스": 6,
    "오'쉐프 브라운소스": 6,
    "오'쉐프 스파게티소스": 6,
    "청포도시럽(홍콩 맥도날드)": 6,
    "오쉐프 오리엔탈샐러드 소스": 6,
    "오'쉐프 정통탕수육소스": 6,
    "오'쉐프 피자소스": 6,
    "우동소스(맛짜우)": 6,
    "유자청양육수(모던샤브하우스)": 6,
    "일식소스(미스터빠삭)": 6,
    "제주감귤베이스(감성커피)": 6,
    "짬뽕소스(10배농축)": 6,
    "찜닭소스(열봉찜닭)": 6,
    "창녕마늘토핑(M)": 3,
    "치포틀레 바비큐소스(대만 맥도날드)": 6,
    "치폴레살사소스(남향)": 6,
    "칠리살사소스(버거앤프라이즈)": 6,
    "칠리소스(지정환피자)": 6,
    "텍사스 BBQ(맥도날드)": 3,
    "토마토 로제소스(이랜드)": 4,
    "토마토베이스소스(웨이브)": 6,
    "토마토소스(더제이케이키친박스)": 4,
    "피나치공 토마토소스": 4,
    "토마토육수(모던샤브하우스)": 4,
    "트러플육수(모던샤브하우스)": 6,
    "폰즈소스(모던샤브하우스)": 6,
    "프리미엄돈카츠소스(그린키친)": 6,
    "피자소스(디엔비)": 6,
    "피자소스(씨앤피시스템)": 6,
    "한국양념치킨소스(대만R)": 4,
    "함박소스(에스피씨지에프에스)": 6,
    "맥도날드_로메스코소스(대만) 500G": 4,
    "맥도날드_유자시럽(홍콩)": 6,
    "스모크바베큐소스(지구인팩토리)": 6,
    "오리엔탈샐러드소스(SW)": 6,
    "바른치킨 골드소스": 6,
    "사골엑기스": 12,
    "레몬엔초비드레싱(그리너)": 6,
    "맛간장소스(백소정)": 6,
    "유부조림소스(백소정)": 6,
    "다시마초소스(백소정)": 6,
    "돈까스소스(이케아)": 6,
    "애플바베큐소스(이랜드)": 6,
    "토마토베이스소스(필라프에빠지다)": 4,
    "유자오리엔탈드레싱(CJ푸드빌)": 6,
    "김치육수(모던샤브하우스)": 4,
    "숯불치킨소스(파파이스)": 6,
    "달콤불갈비소스(버거운버거)": 6,
    "그릴드치킨용소스(샐러드박스)": 6,
    "DRP 스윗데리소스": 6,
    "오꼬노미야끼소스(백소정)": 6,
    "중화풍소스(이랜드)": 6,
    "스파게티소스(오성)": 6,
    "탄두리마살라소스(맘스터치)": 6,
    "이탈리안드레싱(SF)": 6,
    "오꼬노미야끼소스(대만 맥도날드)": 6,
    "양념치킨소스(남문통닭)": 6,
    "왕갈비통닭소스(남문통닭)": 6,
    "오뚜기 데리야끼소스": 6,
    "차콜갈비소스(대만 맥도날드)": 4,
    "김치소스(대만 맥도날드)": 4,
    "블랙닭강정소스(만만닭강정)": 6,
    "피자소스(SF)": 6,
    "토마토베이스소스(셰프스테이)": 6,
    "연탄불고기양념(다미연)": 6,
    "오리엔탈소스(뽁식당)": 6,
    "토마토소스(뽁식당)": 4,
    "토마토스파게티소스(파스타왔어요)": 6,
    "유가네데리소스": 6,
    "매운왕갈비통닭소스(남문통닭)": 6,
    "오'쉐프 통닭양념(순한맛)": 9,
    "오'쉐프 통닭양념(매운맛)": 9,
    "돼지불고기고추장양념(지앤비에프에스)": 6,
    "스위트앤사워소스(대만)": 6,
    "웨스턴BBQ소스(M)": 6,
    "불고기버거소스(BGF)": 6,
    "로제 파스타소스(프레드피자)": 6,
    "돼지불고기간장양념(지앤비에프에스)": 6,
    "닭갈비양념(지앤비에프에스)": 6,
    "닭볶음탕양념(지앤비에프에스)": 6,
    "찜닭양념(지앤비에프에스)": 6,
    "콘짜렐라데리야끼소스(삼송빵집)": 6,
    "타코야끼소스(오이시이)": 6,
    "타바스코칠리소스(M)": 4,
    "올데이표고샤브육수(샤브올데이)": 6,
    "로하살사소스(뽁식당)": 6,
    "엔칠라다소스(뽁식당)": 6,
    "데리야끼소스(번쩍피자)": 6,
    "오'쉐프 겨자냉채소스": 6,
    "칠리소스(S)": 6,
    "한국양념치킨소스(버거용)(대만)": 6,
    "실쏙 토마토 스파게티소스": 6,
    "허니갈릭소스(피나치공)": 6,
    "스파게티소스(파슷타애요)": 6,
    "간장게장소스(경양수산)": 12,
    "자담 허니팝소스": 6,
    "불향데리야끼맛소스(달인)": 6,
    "복분자맛소스(달인)": 6,
    "매운맛소스(달인)": 6,
    "된장맛소스(달인)": 6,
    "양념치킨소스(피나치공)": 6,
    "스파게티소스(탐나는피자)": 6,
    "순후추 닭강정소스": 6,
    "시카고부대찌개다대기": 12,
    "칠리소스(샤브르정원)": 6,
    "스파게티소스(샤브르정원)": 6,
    "양념치킨소스(샤브르정원)": 6,
    "스위트칠리소스(DH)": 6,
    "오리엔탈소스(DH)": 6,
    "제주만다린시럽(홍콩맥도날드)": 6,
    "비빔장(삼교리)": 6,
    "리얼토스트소스(참토스트)": 6,
    "실쏙 데리야끼소스": 6,
    "스파이시소스(참토스트)": 6,
    "매운치킨소스(꼬기다)": 6,
    "간장마늘소스(꼬기다)": 6,
    "치폴레살사소스(M)": 4,
    "데리야끼소스(올바른에프앤비)": 6,
    "마늘족발소스(깐깐한족발)": 6,
    "할라피뇨랠리시(버거킹)": 6,
    "매운왕갈비닭강정소스(노랑강정)": 6,
    "양념치킨소스(SP)": 6,
    "허니치킨소스(SP)": 6,
    "피자소스(이랜드)": 6,
    "그레이비푸틴소스(브뤼셀프라이)": 4,
    "살사로하소스(더타코부스)": 6,
    "피카딜로소스(더타코부스)": 6,
    "스페셜피자소스(M)": 4,
    "매운데리야끼소스(사조원)": 6,
    "오'쉐프 발사믹드레싱": 6,
    "오'쉐프 숯불바베큐소스": 6,
    "비비큐소스(이랜드)": 6,
    "데리야끼소스(푸디스트)": 6,
    "스위트칠리소스(푸디스트)": 6,
    "오리엔탈드레싱(푸디스트)": 6,
    "콕콕콕스파게티소스(세븐일레븐)": 6,
    "코리안소이갈릭소스(대만 맥도날드)": 6,
    "스크램블베이스(참토스트)": 12,
    "오'쉐프 허니머스타드드레싱": 4,
    "오뚜기 허니머스타드소스": 5,
    "케이준소스(대만맥도날드)": 4,
    "레몬딜아이올리소스(대만 맥도날드)": 4,
    "화이트치즈소스(홍콩 맥도날드)": 4,
    "오쉐프_키위드레싱(냉장) 1KG": 4,
    "오쉐프_키위드레싱(냉장) 2KG": 4,
    "스리라차마요소스(맘스터치) 2KG": 4,
    "오'쉐프 참깨드레싱": 4,
    "마요네스(MOS버거)": 4,
    "마요소스": 4,
    "마요네스(파파이스)": 5,
    "맘스버거소스드레싱": 4,
    "파마산갈릭드레싱(대만맥도날드)": 4,
    "마요네스(맘스터치)": 2,
    "마요네스(메이젠)": 4,
    "맥도날드 케이준소스(대만R)": 4,
    "허니머스타드드레싱(급식)": 4,
    "오쉐프 홀그레인허니머스타드드레싱": 6,
    "화이트마요(M)": 4,
    "빅맥소스": 4,
    "스파이시어니언소스": 4,
    "케이준소스(M)": 4,
    "맥치킨소스": 4,
    "창녕마늘 아이올리(M)": 4,
    "프렌치 아이올리": 4,
    "스페셜스모키소스(M)": 4,
    "크리미어니언소스(M)": 4,
    "스리라차마요(M)": 4,
    "트러플랜치소스(M)": 4,
    "크리미파마산소스(M)": 4,
    "할라피뇨마요(M)": 4,
    "맥도날드 케이준소스(홍콩)": 4,
    "스파이시파마산소스(M)": 4
}

st.markdown(
    """
    <style>
    .main {background-color: #fff;}
    div.stTextInput > label, div.stDateInput > label {font-weight: bold;}
    input[data-testid="stTextInput"] {background-color: #eee;}
    .yellow-button button {
      background-color: #FFD600 !important;
      color: black !important;
      font-weight: bold;
    }
    .title {font-size:36px; font-weight:bold;}
    .big-blue {font-size:36px; font-weight:bold; color:#1976D2;}
    .big-red {font-size:36px; font-weight:bold; color:#d32f2f;}
    </style>
    """,
    unsafe_allow_html=True
)

st.markdown(
    """
    <style>
        section.main > div {max-width: 390px; min-width: 390px;}
    </style>
    """,
    unsafe_allow_html=True
)

st.markdown('<div class="title">일부인 계산기</div>', unsafe_allow_html=True)
st.write("")

# -------------------------
# KST(한국시간) 기준 "오늘" 계산
# - 서버가 UTC일 때 날짜가 하루 전으로 보이는 문제를 방지
# -------------------------
KST = datetime.timezone(datetime.timedelta(hours=9))
today_kst = datetime.datetime.now(KST).date()

# 세션 상태 변수 초기화
if "product_input" not in st.session_state:
    st.session_state.product_input = ""
if "auto_complete_show" not in st.session_state:
    st.session_state.auto_complete_show = False
if "selected_product_name" not in st.session_state:
    st.session_state.selected_product_name = ""
if "reset_triggered" not in st.session_state:
    st.session_state.reset_triggered = False
if "confirm_success" not in st.session_state:
    st.session_state.confirm_success = False
if "target_date_value" not in st.session_state:
    st.session_state.target_date_value = ""
if "ocr_result" not in st.session_state:
    st.session_state.ocr_result = None

def reset_all():
    st.session_state.product_input = ""
    st.session_state.selected_product_name = ""
    # date_input을 None으로 두면 환경에 따라 기본값이 다시 UTC 오늘로 잡힐 수 있어
    # 리셋 시에도 KST 오늘로 확실히 맞추기 위해 today_kst를 넣어줌
    st.session_state.date_input = today_kst
    st.session_state.auto_complete_show = False
    st.session_state.reset_triggered = True
    st.session_state.confirm_success = False
    st.session_state.target_date_value = ""
    st.session_state.ocr_result = None

# --- 제품명 입력과 자동완성 ---
st.write("제품명을 입력하세요")

def on_change_input():
    st.session_state.auto_complete_show = True
    st.session_state.selected_product_name = ""

product_input = st.text_input(
    "",
    value=st.session_state.product_input,
    key="product_input",
    on_change=on_change_input
)

input_value = st.session_state.product_input
matching_products = [
    name for name in product_db.keys()
    if input_value.strip() and input_value.strip() in name
]

def select_product(name):
    st.session_state.product_input = name
    st.session_state.selected_product_name = name
    st.session_state.auto_complete_show = False

if input_value.strip() and st.session_state.auto_complete_show:
    st.write("입력한 내용과 일치하는 제품명:")
    st.markdown("""
    <style>
        .scroll-list {
            max-height: 180px;
            overflow-y: auto;
            border:1px solid #ddd;
            padding:5px;
            margin-bottom:5px;
        }
    </style>
    """, unsafe_allow_html=True)
    st.markdown('<div class="scroll-list">', unsafe_allow_html=True)
    for name in matching_products:
        col1, col2 = st.columns([8, 1])
        col1.button(
            name,
            key=f"btn_{name}",
            on_click=select_product,
            args=(name,),
            use_container_width=True
        )
        col2.write("")
    st.markdown('</div>', unsafe_allow_html=True)
elif not input_value.strip():
    st.session_state.selected_product_name = ""
    st.session_state.auto_complete_show = False

# --- 제조일자 입력 ---
st.write("제조일자")

# Streamlit 버전에 따라 date_input의 locale 인자가 없을 수 있어 안전하게 처리
# - locale="ko-KR"가 지원되면 달력 월/요일이 한글로 표시될 가능성이 높음
date_input_kwargs = dict(
    label="",
    key="date_input",
    format="YYYY.MM.DD",
    value=st.session_state.get("date_input", today_kst),
)

try:
    date_input = st.date_input(**date_input_kwargs, locale="ko-KR")
except TypeError:
    # locale 파라미터 미지원 환경 대비
    date_input = st.date_input(**date_input_kwargs)

col1, col2 = st.columns([1, 1])
confirm = col1.button("확인", key="confirm", help="제품명과 제조일자를 확인합니다.", use_container_width=True)
reset = col2.button("새로고침", key="reset", on_click=reset_all, use_container_width=True)

def is_leap_year(year):
    return (year % 4 == 0) and ((year % 100 != 0) or (year % 400 == 0))

def get_last_day(year, month):
    if month in [1,3,5,7,8,10,12]: return 31
    elif month in [4,6,9,11]: return 30
    elif month == 2: return 29 if is_leap_year(year) else 28
    else: return 30

def get_target_date(start_date, months):
    y, m, d = start_date.year, start_date.month, start_date.day
    new_month = m + months
    new_year = y + (new_month - 1) // 12
    new_month = ((new_month - 1) % 12) + 1
    last_day = get_last_day(new_year, new_month)
    if d <= last_day:
        if d == 1:
            return datetime.date(new_year, new_month, 1)
        else:
            return datetime.date(new_year, new_month, d-1)
    else:
        return datetime.date(new_year, new_month, last_day)

# =========================
# 추가 로직(일 단위 소비기한 지원 + 네이버 규칙)
# - 120  -> 120개월
# - "d120" -> 120일
# - 일 단위 목표일부인(네이버 포함 계산): 제조일 + (일수-1)
# =========================
def parse_shelf_life(value):
    """
    반환:
      - ("month", 개월수:int)  예: 120 -> ("month", 120)
      - ("day", 일수:int)      예: "d120" -> ("day", 120)
    """
    if isinstance(value, int):
        return ("month", value)

    if isinstance(value, str):
        v = value.strip()

        if (len(v) >= 2) and (v[0].lower() == "d"):
            num = v[1:].strip()
            if num.isdigit():
                return ("day", int(num))

        if v.isdigit():
            return ("month", int(v))

    raise ValueError(f"소비기한 형식 오류: {value!r} (예: 120 또는 'd120')")

def get_target_date_by_days(start_date, days):
    if days <= 0:
        raise ValueError(f"일 단위 소비기한은 1 이상이어야 합니다: d{days}")
    return start_date + datetime.timedelta(days=days - 1)
# =========================

if confirm:
    pname = st.session_state.product_input
    dt = st.session_state.date_input

    if pname not in product_db.keys():
        st.warning("제품명을 정확하게 입력하거나 목록에서 선택하세요.")
        st.session_state.confirm_success = False
    elif dt is None:
        st.warning("제조일자를 입력하세요.")
        st.session_state.confirm_success = False
    else:
        shelf_life_value = product_db[pname]

        try:
            unit, amount = parse_shelf_life(shelf_life_value)
        except ValueError as e:
            st.warning(str(e))
            st.session_state.confirm_success = False
        else:
            if unit == "day":
                try:
                    target_date = get_target_date_by_days(dt, amount)
                except ValueError as e:
                    st.warning(str(e))
                    st.session_state.confirm_success = False
                else:
                    st.session_state.target_date_value = target_date.strftime('%Y.%m.%d')
                    st.session_state.confirm_success = True
                    st.session_state.ocr_result = None  # OCR 결과 초기화
                    st.success(
                        f"목표일부인: {target_date.strftime('%Y.%m.%d')}",
                        icon="✅"
                    )
                    st.write(f"제품명: {pname}")
                    st.write(f"제조일자: {dt.strftime('%Y.%m.%d')}")
                    st.write(f"소비기한(일): {amount}")
            else:
                months = amount
                target_date = get_target_date(dt, months)
                st.session_state.target_date_value = target_date.strftime('%Y.%m.%d')
                st.session_state.confirm_success = True
                st.session_state.ocr_result = None  # OCR 결과 초기화
                st.success(
                    f"목표일부인: {target_date.strftime('%Y.%m.%d')}",
                    icon="✅"
                )
                st.write(f"제품명: {pname}")
                st.write(f"제조일자: {dt.strftime('%Y.%m.%d')}")
                st.write(f"소비기한(개월): {months}")

if reset:
    st.experimental_rerun()
